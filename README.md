# ğŸ˜¼ ë™ë¬¼ë§ˆì¼“  
[**[ìš°ë¦¬ ë™ë„¤ ë¬¼ë¬¼êµí™˜ ë§ˆì¼“! ë™ë¬¼ë§ˆì¼“ì˜ ë°±ì—”ë“œ ë¦¬í¬ì§€í† ë¦¬ì— ì˜¤ì‹  ì—¬ëŸ¬ë¶„ì„ í™˜ì˜í•©ë‹ˆë‹¤!]**](https://tristy.tistory.com/)  

**ìš°ë¦¬ ë™ë„¤ ë¬¼ë¬¼êµí™˜ ë§ˆì¼“! ë™ë¬¼ë§ˆì¼“!**

ëˆ ì—†ëŠ” ì‚¬ëŒë“¤ë„ ì¤‘ê³  ê±°ë˜ í•˜ê³  í•„ìš”í•œ ë¬¼í’ˆì„ êµ¬í•  ìˆ˜ëŠ” ì—†ì„ê¹Œ?  
ê·¸ëŸ° ë‹¹ì‹ ì„ ë™ë¬¼ ë§ˆì¼“ì´ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤!  

<br/>
<br/>

[**[Fornt-End Github]**](https://github.com/hyemigwak/randomlunch)  
[**[Demo Video]**](https://www.youtube.com/watch?v=dYHfr0oWtcs&feature=youtu.be)  

<p align="center"><img src="https://user-images.githubusercontent.com/52685665/119868462-05c9b880-bf5a-11eb-9619-c6697f060f7c.jpg" width=50% ></p>
<p align="center"><img src="https://user-images.githubusercontent.com/52685665/119868640-4295af80-bf5a-11eb-8f09-f25d272a63b9.jpg" width=50% ></p>


<br/>
<br/>

ğŸ¤” Team
-------------  
[Front-End] [ê³½í˜œë¯¸](https://github.com/hyemigwak), [ì´ì§€ì€](https://github.com/Jinnycorn)  
[Back-End] ì›ë™ê· , [ì´ì¬ìœ¤](https://github.com/Leejaeyoon94)  

<br/>
<br/>


ğŸ¤” í”„ë¡œì íŠ¸ ê°œìš”
-------------  
<ul style="list-style-type: disc;" data-ke-list-type="disc">
<li><b>ì§„í–‰ ë‚ ì§œ - 2021.04.23 ~ 2021.05.28 </b></li>
<li><b>ëª©ì  - íŒ€ì›ë“¤ê³¼ í•¨ê»˜, ë°±ì—”ë“œì™€ í”„ë¡ íŠ¸ ì—”ë“œì˜ ì—­í• ì„ ë§¡ì•„ ì£¼ì œë¥¼ ì„ ì •í•˜ê³  í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•˜ì</b></li>
<li><b>í•„ìˆ˜ í¬í•¨ ì‚¬í•­</b></li>
</ul>

<br/>
<br/>

<p align="center"><img src="https://blog.kakaocdn.net/dn/dwsJdX/btq5vfsvhgR/Cpdc3RBItuKL8iKC9sh4k1/img.png"></p>


<br/>
<br/>


ğŸ˜ Architecture
-----------------  

<p align="center"><img src="https://user-images.githubusercontent.com/52685665/119842034-4c5ee900-bf41-11eb-9164-c4bba92822f2.png"></p>


<br/>
<br/>

ğŸ˜ ERD
-----------------  

<br/>
<br/>

ì±„íŒ…ë°© ê´€ë¦¬ë¥¼ ìœ„í•´ ì±„íŒ…ë°© í…Œì´ë¸”, ì±„íŒ… í…Œì´ë¸” ìœ ì €, ì±„íŒ… ë©”ì‹œì§€ í…Œì´ë¸”ì„ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.  
ë˜í•œ ê°•í‡´ë‹¹í•œ ì‚¬ëŒ ê´€ë¦¬ë¥¼ ìœ„í•´ ê°•í‡´ í…Œì´ë¸”ë„ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.  

ì €í¬ saleItem í…Œì´ë¸”ì—ëŠ” statusë¼ëŠ” ì½”ë“œê°€ ìˆëŠ”ë° ì´ë¥¼ ìœ„í•´ì„œ codeë¼ëŠ” ê³µí†µ ì½”ë“œ ê´€ë¦¬ í…Œì´ë¸”ì„ ë§Œë“¤ì–´ì„œ  
ì–¸ì œë“ ì§€ ë‚´ìš©ì„ ì‰½ê²Œ ë°”ê¿€ ìˆ˜ ìˆë„ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤.  

ë˜í•œ saleItem rowëŠ” deadeLine ì»¬ëŸ¼ì˜ ì‹œê°„ì´ ì§€ë‚˜ë©´ ìë™ìœ¼ë¡œ statusê°€ ë³€ê²½ë˜ì–´ì•¼ í–ˆê¸° ë•Œë¬¸ì— ì•„ë˜ì˜ ì´ë²¤íŠ¸ë¥¼ ì ìš©í–ˆìŠµë‹ˆë‹¤.  

```sql
CREATE EVENT IF NOT EXISTS exchange_Fail ON SCHEDULE EVERY 1 HOUR STARTS '2021-05-20 00:00:00'
    ON COMPLETION NOT PRESERVE
    ENABLE
    COMMENT 'If the exchange is not made within the specified time, make it fail...'
    DO 
    UPDATE saleItem SET status = 'SI03' WHERE status = 'SI01' AND deadLine <= now();
```

<br/>
<br/>

<p align="center"><img src="https://user-images.githubusercontent.com/52685665/119867416-d6ff1280-bf58-11eb-9126-97937cf8221d.png"></p>


<br/>
<br/>

ğŸ¤­ Nest Js Socket Io   
-----------------

<br/>
<br/>

ì €í¬ëŠ” Nest Jsë¥¼ ì‚¬ìš©í•´ì„œ Socket Io ì„œë¹„ìŠ¤ë¥¼ êµ¬í˜„í•˜ì˜€ìŠµë‹ˆë‹¤.  
í•˜ë©´ì„œ ê°€ì¥ ì–´ë ¤ì› ë˜ ì ì€ ì¼ë‹¨ Nest Js Socket Io ì˜ˆì œê°€ ë„ˆë¬´ ì ì—ˆìŠµë‹ˆë‹¤.  
ê·¸ë˜ì„œ ê³µì‹ë¬¸ì„œë¥¼ ë³´ë©´ì„œ ì´í•´ë¥¼ í•˜ì˜€ê³  ì´í•´í•˜ì§€ ëª»í•œ ê¸°ìˆ ë“¤ì€ **Nest Js Discord**ì—ì„œ í•´ë‹µì„ ì–»ê±°ë‚˜  
**StackOverFlow**ì— ë¬¼ì–´ë³´ëŠ” ì‹ìœ¼ë¡œ í•´ê²°í•˜ì˜€ìŠµë‹ˆë‹¤.

<br/>
<br/>

Nest JsëŠ” Socket Ioë¥¼ ì‚¬ìš©í•  ë•Œ **@WebSocketGateway**ë¥¼ ì‚¬ìš©í•´ì„œ Socket io ì—°ê²°ì„ ì§„í–‰í•©ë‹ˆë‹¤.  

```javascript
@WebSocketGateway({
	namespace: '/chatting'
})
export class ChatGateway
	implements OnGatewayInit, OnGatewayConnection, OnGatewayDisconnect {
  }
```

<br/>
<br/>

ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ë•ŒëŠ” javascript socket ioì™€ ë˜‘ê°™ì´ emitìœ¼ë¡œ ë³´ë‚´ê³  onìœ¼ë¡œ ë°›ìŠµë‹ˆë‹¤.  
ë‹¤ë§Œ, Nest JsëŠ” onìœ¼ë¡œ ì†Œì¼“ì„ ë°›ì§€ì•Šê³  **@SubscribeMessage()** ë¥¼ ì‚¬ìš©í•´ì„œ ë°›ìŠµë‹ˆë‹¤.  

ì¦‰, ë³´ë‚´ëŠ” ìª½ì—ì„œ emit('sendMsg')ë¡œ ë³´ë‚´ë©´ chat.gateway.tsì—ì„œëŠ” @SubscribeMessage('sendMsg')ë¡œ ë°›ìŠµë‹ˆë‹¤.

```javascript
	@SubscribeMessage('sendMsg')
	async handleMessage(client: Socket, itemChatDto: ItemChatDto) {
		const chatMsg = await this.chatService.saveChatMsg(itemChatDto);
		if (chatMsg['msg'] == 'success') {
			this.server.to(itemChatDto.icrId).emit('getMsg', chatMsg['data']);
		} else {
			client.emit('getMsg', chatMsg['errorMsg']);
		}
	}
```


<br/>
<br/>

ğŸ¤­ Nginx   
-----------------

<br/>
<br/>

ì›¹ì‚¬ì´íŠ¸ì˜ ë™ì‹œì ‘ì† ì²˜ë¦¬ë¥¼ ìœ„í•´ Nginxë¥¼ ì‚¬ìš©í•˜ì˜€ìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ê·¸ ì¤‘ìš”í•œ ë¡œë“œë°¸ëŸ°ì‹± ì²˜ë¦¬ëŠ” ì•ˆë¼ ìˆìŠµë‹ˆë‹¤.  
ì €í¬ê°€ í”„ë¡ íŠ¸ì™€ í•¨ê»˜ ì±„íŒ… ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ëŠ”ë° ë„ˆë¬´ ì˜¤ëœ ì‹œê°„ì´ ê±¸ë ¸ê¸° ë•Œë¬¸ì— ê·¸ëŸ°ê±¸ ì‹ ê²½ì“¸ ì‹œê°„ì´ ì—†ì—ˆë‹µë‹ˆë‹¤.  
ë”êµ°ë‹¤ë‚˜, ì¤‘ê°„ì— ì„¤ì •ì„ ì˜ëª»í•´ ë²„ë ¤ì„œ ìê¾¸ cors ë¬¸ì œê°€ ë–³ìŠµë‹ˆë‹¤.  

<br/>
<br/>

ì²˜ìŒì—ëŠ” í•´ë‹¹ ì½”ë“œë¥¼ ì‚¬ìš©í•´ì„œ nginxë¥¼ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.  
ê·¸ëŸ°ë° ì´ë ‡ê²Œ ì‚¬ìš©í•˜ì˜€ì„ ë•Œ ë°œìƒí•œ ë¬¸ì œì ì˜ ê½¤ë‚˜ ì–´ë©”ì´ì§• í–ˆìŠµë‹ˆë‹¤.  


```bash
server {
            server_name dongmul.shop;
            location / {
                        proxy_hide_header Access-Control-Allow-Origin;
                        add_header 'Access-Control-Allow-Origin' '*';
                        proxy_set_header HOST $host;
                        proxy_pass https://127.0.0.1:3000;
                        proxy_redirect off;
           }

            listen 443 ssl;
            ssl_certificate /etc/letsencrypt/live/dongmul.shop/fullchain.pem;
            ssl_certificate_key /etc/letsencrypt/live/dongmul.shop/privkey.pem;
            include /etc/letsencrypt/options-ssl-nginx.conf;
            ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
            client_max_body_size 0;
}

# 80í¬íŠ¸ë¡œ ë“¤ì–´ì™€ë„ 443ìœ¼ë¡œ êº¾ì–´ì¤˜ì•¼ ë¼
server {
            server_name dongmul.shop;
            listen 80;
            listen [::]:80;
            return 301 https://$host$request_uri;
}

```
  
<br/>
<br/>  
  
### 1. proxy_hide_headerë¡œ ì¸í•œ cors  

ì¼ë‹¨, ëª‡ëª‡ apiì—ì„œ cors ë¬¸ì œê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ apiëŠ” ì˜ ì‘ë™í•˜ëŠ”ë° ì–´ë–¤ api í•˜ë‚˜ë§Œ cors ë¬¸ì œê°€ ë–³ìŠµë‹ˆë‹¤.  
ê·¸ë˜ì„œ ë¬¸ì œë¥¼ ì°¾ëŠ” ê²ƒì´ ì‰½ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì°¾ì•„ë³´ë‹ˆ proxy_hide_headerë¼ëŠ” ë…€ì„ì´  
í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ìˆ¨ê¸¸ í—¤ë”ë¥¼ ì¶”ê°€í•˜ëŠ” ê¸°ëŠ¥ì„ í•˜ëŠ”ë°, ìˆ¨ê²¨ë²„ë¦¬ëŠ” ë°”ëŒì— cors ë¬¸ì œê°€ ë°œìƒí•œ ê²ƒì´ ì•„ë‹Œê°€ ì‹¶ìŠµë‹ˆë‹¤.  

ì‹¤ì œë¡œ í•´ë‹¹ ì½”ë“œë¥¼ ì œê±°í•˜ë‹ˆ cors ë¬¸ì œëŠ” ë°œìƒí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.  

<br/>
<br/>

### 2. add_headerë¡œ ì¸í•œ ë¬¸ì œ ë°œìƒ  

ì œê°€ ì°©ê°ì„ í–ˆë˜ê²Œ Nginxë¥¼ ì‚¬ìš©í•˜ë©´, Nest jsì—ì„œ corsë¥¼ í•´ì£¼ê³ , Nginxì—ì„œë„ í•œë²ˆ ë” í•´ì¤˜ì•¼ í•œë‹¤ê³  ìƒê°í–ˆìŠµë‹ˆë‹¤.  
ê·¸ë˜ì„œ ë‘˜ë‹¤ cors ì²˜ë¦¬ë¥¼ í•´ì£¼ì—ˆëŠ”ë°, ì´ë ‡ê²Œ í•˜ë‹ˆê¹Œ Access-Control-Allow-Origin í—¤ë”ê°€ 2ê°œì”© ì˜¬ë¼ê°€ì„œ ì˜¤ë¥˜ê°€ ìƒê²¼ìŠµë‹ˆë‹¤.  

ìš°ì—¬ê³¡ì ˆ ëì— ë¬¸ì œì ì„ ì°¾ì•„ë‚´ì„œ í˜„ì¬ ì €í¬ ë™ë¬¼ ë§ˆì¼“ Nginx ì„¤ì •ì€ ì´ë ‡ê²Œ ë˜ì–´ ìˆìŠµë‹ˆë‹¤.  

```bash
server {
            server_name dongmul.shop;
            location / {
                        proxy_set_header HOST $host;
                        proxy_pass https://127.0.0.1:3000;
                        proxy_redirect off;
           }

            listen 443 ssl;
            ssl_certificate /etc/letsencrypt/live/dongmul.shop/fullchain.pem;
            ssl_certificate_key /etc/letsencrypt/live/dongmul.shop/privkey.pem;
            include /etc/letsencrypt/options-ssl-nginx.conf;
            ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
            client_max_body_size 0;
}

server {
            server_name dongmul.shop;
            listen 80;
            listen [::]:80;
            return 301 https://$host$request_uri;
}

``` 

ì•„ë¬´ë˜ë„ https í™˜ê²½ì´ê³  Nginxë„ ì²˜ìŒ ì„¤ì •í•˜ëŠ” ê²ƒì´ë‹¤ ë³´ë‹ˆ, ì—„ì²­ë‚˜ê²Œ ì˜¤ë¥˜ê°€ ë§ì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤.  
í”„ë¡ íŠ¸ì—ì„œëŠ” cors ë¬¸ì œê°€ ë°œìƒí•˜ëŠ”ë° nginxì—ëŠ” ì–´ë–¤ ë¡œê·¸ë„ ì•ˆì°íˆëŠ” ê²½ìš°ë„ ìˆì—ˆê³ , ê·¸ëŸ¬ë‹¤ë³´ë‹ˆ íŠ¸ëŸ¬ë¸” ìŠˆíŒ…í•˜ëŠ” ê²ƒë„  
ì—„ì²­ ì˜¤ë˜ ê±¸ë ¸ìŠµë‹ˆë‹¤ ã… ã… ....  

ì†Œì¼“ì´ë‘ nginx ê¸°ë³¸ ì„¤ì •í•˜ëŠ” ê³³ì—ì„œ íŠ¸ëŸ¬ë¸” ìŠˆíŒ…í•˜ëŠ”ê±°ì— ì‹œê°„ì„ ë§ì´ ëºê¸°ì§€ ì•Šì•˜ë‹¤ë©´ ì¢€ ë” ë§ì´ ê°œë°œì„ í•  ìˆ˜ ìˆì—ˆì„ ê±°ë€ ìƒê°ì´ ë“­ë‹ˆë‹¤.
